name: "Test"
on:
  # Workflow dispatch is used for manual triggers
  workflow_dispatch:
  # Workflow call is used for called from another workflow
  workflow_call:
    secrets:
      CR_SECRET:
        description: "Secret to authenticate if using an other container registry than Github"
        required: false

env:
  REGISTRY: ghcr.io
  API_IMAGE_PATH: ${{ github.repository }}/api
  WEB_IMAGE_PATH: ${{ github.repository }}/web

jobs:
  api-unit-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./api
    steps:
      - name: "Setup: checkout repository"
        uses: actions/checkout@v4

      - name: "Setup: install poetry"
        run: pipx install poetry

      - name: "Setup: add python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "poetry"

      - name: "Run: pytest unit tests"
        run: poetry run pytest --unit

  api-integration-tests:
    runs-on: ubuntu-latest
    steps:
      - name: "Setup: checkout repository"
        uses: actions/checkout@v4

      - name: "Setup: Login to GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # - name: "Setup: Docker Buildx"
      #   uses: docker/setup-buildx-action@v3
      #
      # - name: "Setup: Build API image"
      #   uses: docker/build-push-action@v6
      #   with:
      #     context: ./api
      #     target: development
      #     load: true
      #     tags: ${{ env.REGISTRY }}/${{ env.API_IMAGE_PATH }}:buildcache
      #     cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.API_IMAGE_PATH }}:buildcache

      # - name: Build API image
      #   run: |
      #     docker pull $API_IMAGE
      #     docker build --target development --tag api-development ./api # TODO: --cache-from $API_IMAGE

      - name: Pytest Integration tests
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml run --rm api python -m pytest --integration

      - name: BDD Integration tests
        if: ${{ false }} # disable for now
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml run api behave

  web-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Login to GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Web Image
        run: |
          docker pull ${REGISTRY}/${WEB_IMAGE_PATH}
          docker build --cache-from ${REGISTRY}/${WEB_IMAGE_PATH} --target development --tag web-dev ./web

      - name: Run Web tests
        if: ${{ false }} # disable for now as they do not currently work
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml run --rm web yarn test

  docs-tests:
    name: test-docs
    runs-on: ubuntu-latest

    steps:
      # If you know your docs does not rely on anything outside of the documentation folder, the commented out code below can be used to only test the docs build if the documentation folder changes.
      - name: Checkout GitHub Action
        uses: actions/checkout@v4
        # with:
        #   fetch-depth: 0

      # - name: "Get number of changed documentation files"
      #   id: docs-changes
      #   shell: bash
      #   run: echo "changes=$(git diff --name-only $(git merge-base HEAD origin/main) HEAD | grep documentation/ | wc -l)" >> $GITHUB_OUTPUT

      - name: Setup node
        # if: steps.docs-changes.outputs.changes > 0
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: documentation/yarn.lock

      - name: Install dependencies and build website
        # if: steps.docs-changes.outputs.changes > 0
        run: |
          cd documentation
          yarn install --frozen-lockfile
          yarn build
